name: Build, Deploy Docker Image and Koyeb Deployment

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v2

      # 2. Build Docker image
      - name: Build Docker image
        run: |
          docker build -t ghcr.io/<YOUR_GITHUB_USERNAME>/<YOUR_DOCKER_IMAGE_NAME>:latest .

      # 3. Login to GitHub Container Registry
      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u <YOUR_GITHUB_USERNAME> --password-stdin

      # 4. Push Docker image to GitHub Container Registry
      - name: Push Docker image to GitHub Container Registry
        run: |
          docker push ghcr.io/<YOUR_GITHUB_USERNAME>/<YOUR_DOCKER_IMAGE_NAME>:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v2

      # 2. Install Koyeb CLI
      - name: Install Koyeb CLI
        run: npm install -g @koyeb/cli

      # 3. Login to Koyeb
      - name: Login to Koyeb
        run: koyeb login --apiKey "${{ secrets.KOYEB_API_TOKEN }}"

      # 4. Deploy to Koyeb
      - name: Deploy to Koyeb
        run: koyeb deploy <YOUR_SERVICE_NAME> --image ghcr.io/<YOUR_GITHUB_USERNAME>/<YOUR_DOCKER_IMAGE_NAME>:latest
